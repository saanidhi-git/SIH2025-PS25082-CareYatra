<!DOCTYPE html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" /> 
    <meta name="viewport" content="width=device-width, initial-scale=1" /> 
    <title>CareYatra Dashboard</title> 
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Fredoka+One&display=swap" rel="stylesheet"> 
    <style> 
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap'); 
        body, html { 
            margin: 0; 
            padding: 0; 
            height: 100%; 
            font-family: 'Nunito', sans-serif; 
            background: url("assets/BG.jpg") no-repeat center center fixed; 
            background-size: cover; 
            min-height: 100vh; 
            overflow-y: auto; 
        } 
        .wrapper { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            padding: 20px 0; 
            box-sizing: border-box; 
        } 
        .dashboard { 
            display: flex; 
            background: #f8fafc; 
            border-radius: 24px; 
            box-shadow: 0 12px 40px rgba(38,86,165,0.12); 
            width: 90%; 
            max-width: 1400px; 
            height: auto; 
            min-height: 90vh; 
            overflow: hidden; 
            align-items: stretch; 
        } 
        .sidebar { 
            width: 260px; 
            background: linear-gradient(180deg, #7fd6e9 0%, #5285ec 100%); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 32px 0 16px 0; 
            border-top-left-radius: 24px; 
            border-bottom-left-radius: 24px; 
        } 
        .sidebar .logo-row { 
            text-align: center; 
            width: 100%; 
            margin-bottom: 8px; 
        } 
        .sidebar .logo-container { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        } 
        .sidebar .logo-container img { 
            max-width: 150px; 
            height: auto; 
            margin-bottom: 5px; 
        } 
        .sidebar .usertype { 
            color: #f7e176; 
            font-weight: bold; 
            font-size: 1.05rem; 
            margin-top: 2px; 
            margin-bottom: 12px; 
            letter-spacing: 0.2px; 
            text-shadow: 0 1px 6px rgba(38,86,165,0.10); 
            text-align: center; 
        } 
        .sidebar .profilepic { 
            width: 62px; 
            height: 62px; 
            border-radius: 50%; 
            background: #cae6ff; 
            margin: 0 auto 0.7rem auto; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 2rem; 
            color: #5285ec; 
        } 
        .sidebar .welcome { 
            font-size: 1rem; 
            color: #fff; 
            font-weight: 600; 
            letter-spacing: 0.2px; 
            margin-bottom: 18px; 
        } 
        .sidebar .sidebar-btns { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 16px; 
            width: 90%; 
            justify-items: center; 
            margin-top: 20px; 
        } 
        .sidebar .sidebar-btn { 
            width: 100px; 
            height: 90px; 
            background: rgba(255,255,255,0.14); 
            color: #fff; 
            font-size: 1rem; 
            font-weight: 600; 
            border-radius: 14px; 
            border: 2px solid transparent; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            gap: 6px; 
            text-align: center; 
            transition: all 0.25s ease; 
            box-shadow: 0 2px 8px rgba(86,86,165,0.06); 
        } 
        .sidebar .sidebar-btn.active, 
        .sidebar .sidebar-btn:hover { 
            background: #fff7ed; 
            color: #205493; 
            border: 2px solid #e66892; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 10px rgba(86,86,165,0.1); 
        } 
        .sidebar .logout-btn { 
            margin-top: 32px; 
            background: #f87171; 
            color: #fff; 
            font-weight: bold; 
            width: 80%; 
            font-size: 1rem; 
            padding: 10px; 
            border-radius: 12px; 
            cursor: pointer; 
            transition: background 0.25s ease, transform 0.1s ease; 
        } 
        .sidebar .logout-btn:hover { 
            background: #ef4444; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.2); 
        } 
        .sidebar .qrcode-container { 
            margin-top: 40px; 
            text-align: center; 
        } 
        .sidebar .qrcode-container img { 
            width: 150px; 
            height: 150px; 
            cursor: pointer; 
            transition: transform 0.2s ease; 
        } 
        .sidebar .qrcode-container img:hover { 
            transform: scale(1.05); 
        } 
        main.inner-window { 
            flex: 1; 
            background: #f7fbff; 
            padding: 38px 34px 34px 34px; 
            min-height: 690px; 
            border-top-right-radius: 24px; 
            border-bottom-right-radius: 24px; 
            box-sizing: border-box; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            overflow-y: auto; 
        } 
        .tab { 
            display: none; 
            animation: fadein 350ms; 
        } 
        .tab.active { 
            display: block; 
        } 
        @keyframes fadein { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        } 
        .tab-title { 
            font-size: 2.1rem; 
            font-weight: bold; 
            color: #5285ec; 
            text-shadow: 0 2px 12px rgba(38,86,165,0.10); 
            margin-bottom: 26px; 
            letter-spacing: 1px; 
        } 
        .content-card { 
            background: linear-gradient(135deg, #cbe4f5 0%, #aedbe8 60%, #ddeafb 100%); 
            border-radius: 18px; 
            box-shadow: 0 2px 14px rgba(38,86,165,0.10); 
            padding: 28px 22px; 
            margin-bottom: 24px; 
            font-size: 1.12rem; 
        } 
        .chart-box { 
            padding: 24px; 
            border-radius: 16px; 
            background: #e5f2fc; 
            display: flex; 
            gap: 48px; 
            justify-content: center; 
            align-items: center; 
        } 
        .pie-chart, .bar-chart { 
            width: 180px; 
            height: 120px; 
            background: #fff; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px #dde8ff; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: #5285ec; 
            font-size: 1.1rem; 
            font-weight: 600; 
        } 
        .family-emergency-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 35px; 
        } 
        .family-box, .emergency-box { 
            border-radius: 22px; 
            padding: 28px 22px 24px 22px; 
            box-shadow: 0 6px 20px rgba(86,86,165,0.08); 
        } 
        .family-box { 
            background: #e3f0fd; 
        } 
        .emergency-box { 
            background: #ffe3ed; 
        } 
        .family-box .family-title, 
        .emergency-box .emergency-title { 
            font-size: 1.7rem; 
            font-weight: bold; 
            margin-bottom: 18px; 
            line-height:1.1em; 
        } 
        .family-title { 
            color: #6185d6; 
        } 
        .emergency-title { 
            color: #e66892; 
        } 
        .family-list, .emergency-list { 
            list-style: none; 
            padding: 0; 
            margin: 0; 
        } 
        .family-list li { 
            padding: 13px 18px; 
            border-radius: 14px; 
            background: #fff; 
            margin-bottom: 16px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            box-shadow: 0 1px 4px rgba(0,0,0,0.06); 
            transition: transform 0.2s ease, box-shadow 0.2s ease; 
        } 
        .family-list li:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 3px 8px rgba(0,0,0,0.1); 
        } 
        .family-actions button { 
            font-size: 1rem; 
            padding: 7px 12px; 
            border-radius: 7px; 
            border:none; 
            margin-right:7px; 
            cursor:pointer; 
            font-weight:600; 
            transition: all 0.2s ease; 
        } 
        .link-btn { 
            background: #d7ebfd; 
            color: #2779bd; 
        } 
        .link-btn:hover { 
            background: #b6dcf8; 
            transform: scale(1.05); 
        } 
        .remove-btn { 
            background: #f5d4da; 
            color: #d45a91; 
        } 
        .remove-btn:hover { 
            background: #f1b3c3; 
            transform: scale(1.05); 
        } 
        .options-menu { 
            display:none; 
            position:absolute; 
            top:40px; 
            right:0; 
            background:#fff; 
            border-radius:8px; 
            box-shadow:0 2px 10px rgba(0,0,0,0.11); 
            font-size:1em; 
            min-width:144px; 
            z-index:3; 
        } 
        .option-item { 
            padding: 13px 14px; 
            cursor: pointer; 
            transition: background 0.18s; 
            border-bottom: 1px solid #f3f4f7; 
        } 
        .option-item:last-child { 
            border-bottom: none; 
        } 
        .option-item:hover { 
            background: #e3f0fd; 
        } 
        .family-list li:last-child .family-actions button { 
            margin-right:0; 
        } 
        .add-member-form { 
            background: #d3e5f2; 
            border-radius: 16px; 
            padding: 18px 14px; 
            margin-top:2px; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.05); 
        } 
        .add-member-form label { 
            font-weight: 600; 
            color: #6185d6; 
            display: block; 
            margin-bottom: 9px; 
            font-size: 1rem; 
        } 
        .add-member-form input, .add-member-form select { 
            border-radius: 7px; 
            width: 100%; 
            border: 1px solid #90cbe7; 
            padding: 8px 14px; 
            margin-bottom: 9px; 
            background: #fff; 
            font-size: 1rem; 
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08); 
            transition: border-color 0.2s ease; 
            box-sizing: border-box; 
        } 
        .add-member-form input:focus, .add-member-form select:focus { 
            outline: none; 
            border-color: #5285ec; 
            box-shadow: 0 0 0 2px rgba(82, 133, 236, 0.2); 
        } 
        .add-member-form button { 
            background:#e66892; 
            color:#fff; 
            border:none; 
            border-radius:8px; 
            padding:11px 32px; 
            cursor:pointer; 
            font-size:1rem; 
            font-weight:600; 
            transition: background 0.2s ease, transform 0.1s ease; 
        } 
        .add-member-form button:hover { 
            background:#d44b78; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 10px rgba(230, 104, 146, 0.2); 
        } 
        .appointment-form input { 
            border-radius: 12px; 
            border: 1px solid #cce5ff; 
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08); 
            padding: 12px 14px; 
            transition: border-color 0.2s ease; 
        } 
        .appointment-form input:focus { 
            outline: none; 
            border-color: #5285ec; 
            box-shadow: 0 0 0 2px rgba(82, 133, 236, 0.2); 
        } 
        .appointment-form button { 
            background: #5285ec; 
            transition: background 0.25s ease, transform 0.1s ease; 
            box-shadow: 0 4px 10px rgba(82, 133, 236, 0.2); 
            font-weight: 700; 
            border: none; 
            border-radius: 12px; 
            padding: 12px 30px; 
            cursor: pointer; 
        } 
        .appointment-form button:hover { 
            background: #3967c3; 
            transform: translateY(-2px); 
            box-shadow: 0 6px 15px rgba(82, 133, 236, 0.3); 
        } 
        .tab-documents .content-card div { 
            background: #eef7ff; 
            padding: 20px; 
            border-radius: 16px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
            transition: transform 0.2s ease, box-shadow 0.2s ease; 
        } 
        .tab-documents .content-card div:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 6px 18px rgba(0,0,0,0.08); 
        } 
        .document-upload-button { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            padding: 20px; 
            border-radius: 16px; 
            border: 2px dashed #aedbe8; 
            background: #eef7ff; 
            color: #5285ec; 
            transition: all 0.2s ease; 
        } 
        .document-upload-button:hover { 
            background: #e5f2fc; 
            border-color: #5285ec; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(82,133,236,0.1); 
        } 
        .document-upload-button img { 
            width: 50px; 
            height: 50px; 
            margin-bottom: 10px; 
        } 
        .profile-form-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px 40px; 
        } 
        .profile-form-grid label { 
            display: block; 
            font-weight: 600; 
            color: #5285ec; 
            margin-bottom: 8px; 
        } 
        .profile-form-grid input, .profile-form-grid select { 
            width: 100%; 
            padding: 12px; 
            border-radius: 10px; 
            border: 1px solid #cce5ff; 
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.08); 
            transition: border-color 0.2s ease, box-shadow 0.2s ease; 
            box-sizing: border-box; 
        } 
        .profile-form-grid input:focus, .profile-form-grid select:focus { 
            outline: none; 
            border-color: #5285ec; 
            box-shadow: 0 0 0 2px rgba(82, 133, 236, 0.2); 
        } 
        .vaccination-section { 
            margin-top: 24px; 
            border-top: 1px dashed #cce5ff; 
            padding-top: 20px; 
        } 
        .qr-code-box { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 40px; 
            background: #fff; 
            border-radius: 16px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
            text-align: center; 
        } 
        .qr-code-box img { 
            max-width: 200px; 
            margin-bottom: 15px; 
        } 
        .qr-code-box p { 
            color: #666; 
            font-size: 1.1em; 
            font-weight: 600; 
        } 
        .finalized-profile-view { 
            background: #eef7ff; 
            border-radius: 18px; 
            padding: 28px 32px; 
            box-shadow: 0 4px 12px rgba(82, 133, 236, 0.1); 
        } 
        .finalized-profile-view p { 
            margin-bottom: 8px; 
            font-size: 1.1rem; 
            color: #333; 
        } 
        .finalized-profile-view p strong { 
            color: #5285ec; 
        } 
        .finalized-vaccination-list li { 
            background: #fff; 
            border-radius: 8px; 
            padding: 12px 18px; 
            margin-bottom: 10px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 1rem; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        } 
        .finalized-vaccination-list li .edit-btn { 
            background: #6185d6; 
            color: #fff; 
            border: none; 
            padding: 6px 12px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 0.9em; 
        } 
        .language-input-container { 
            position: relative; 
        } 
        .language-tag-display { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            padding: 8px 12px; 
            border-radius: 10px; 
            background: #fff; 
            border: 1px solid #cce5ff; 
            min-height: 48px; 
            box-sizing: border-box; 
            cursor: text; 
        } 
        .language-tag { 
            display: inline-flex; 
            align-items: center; 
            background: #d7ebfd; 
            color: #2779bd; 
            padding: 4px 8px; 
            border-radius: 6px; 
            font-size: 0.9em; 
            font-weight: 600; 
        } 
        .language-tag .remove-tag { 
            margin-left: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            color: #1e649b; 
        } 
        #languageInput { 
            width: 100%; 
            border: none; 
            outline: none; 
            padding: 0; 
            background: transparent; 
            font-size: 1rem; 
            flex-grow: 1; 
        } 
        .language-suggestions { 
            position: absolute; 
            z-index: 10; 
            width: 100%; 
            max-height: 180px; 
            overflow-y: auto; 
            border: 1px solid #ddd; 
            background: #fff; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
            margin-top: 5px; 
            list-style: none; 
            padding: 0; 
        } 
        .language-suggestions li { 
            padding: 12px; 
            cursor: pointer; 
            font-size: 1rem; 
        } 
        .language-suggestions li:hover { 
            background: #f0f4f7; 
        } 
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: rgba(0, 0, 0, 0.5); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 100; 
        } 
        .modal-content { 
            background: #f8fafc; 
            padding: 40px; 
            border-radius: 24px; 
            box-shadow: 0 12px 40px rgba(38,86,165,0.12); 
            width: 380px; 
            max-width: 90%; 
            text-align: center; 
            position: relative; 
        } 
        .close-modal { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            background: transparent; 
            border: none; 
            font-size: 1.5rem; 
            cursor: pointer; 
            color: #999; 
            transition: color 0.2s ease; 
        } 
        .close-modal:hover { 
            color: #555; 
        } 
        .modal-content h3 { 
            font-size: 1.5rem; 
            color: #5285ec; 
            margin-bottom: 20px; 
        } 
        .modal-upload-btn-container { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            width: 180px; 
            height: 150px; 
            margin: 0 auto; 
            border-radius: 16px; 
            border: 2px dashed #7eaed0; 
            background: #d8ecff; 
            color: #5285ec; 
            transition: all 0.2s ease; 
        } 
        .modal-upload-btn-container:hover { 
            background: #c3e2f7; 
            border-color: #5285ec; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(82,133,236,0.1); 
        } 
        .modal-upload-btn-container img { 
            width: 60px; 
            height: 60px; 
            margin-bottom: 10px; 
        } 
        .modal-upload-btn-container p { 
            font-weight: 600; 
            margin: 0; 
            font-style: italic; 
        } 
        .uploaded-file-name { 
            margin-top: 15px; 
            font-style: italic; 
            color: #666; 
            font-size: 0.9em; 
        } 
        #uploadedFilesDisplay { 
            list-style: none; 
            padding: 0; 
            margin-top: 20px; 
            border-top: 1px dashed #cce5ff; 
        } 
        #uploadedFilesDisplay li { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 0; 
            border-bottom: 1px solid #eee; 
            font-size: 1rem; 
        } 
        .file-icon { 
            margin-right: 10px; 
            color: #5285ec; 
            font-size: 1.2em; 
        } 
        .message-box { 
            position: fixed; 
            top: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            background: #4CAF50; 
            color: #fff; 
            padding: 15px 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); 
            z-index: 200; 
            display: none; 
            animation: slideIn 0.5s forwards; 
            font-weight: 600; 
        } 
        @keyframes slideIn { 
            from { transform: translateX(-50%) translateY(-100px); opacity: 0; } 
            to { transform: translateX(-50%) translateY(0); opacity: 1; } 
        } 

        /* ABHA AI Chatbot */ 
        .abha-logo-container { 
            position: absolute; 
            bottom: 20px; 
            right: 28px; 
            z-index: 10; 
        } 
        .abha-logo { 
            width: 80px; 
            height: auto; 
            opacity: 0.9; 
            cursor: pointer; 
            transition: transform 0.2s ease; 
        } 
        .abha-logo:hover { 
            transform: scale(1.05); 
        } 
        .chatbot-overlay { 
            position: absolute; 
            bottom: 120px; 
            right: 40px; 
            width: 380px; 
            height: 600px; 
            background: #f7fbff; 
            border-radius: 18px; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.2); 
            display: none; 
            flex-direction: column; 
            z-index: 1000; 
            overflow: hidden; 
        } 
        .chatbot-window { 
            display: flex; 
            flex-direction: column; 
            height: 100%; 
            position: relative; 
        } 
        .chatbot-header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            background: #d5c9f0; 
            padding: 12px 16px; 
            font-family: "Fredoka One", cursive; 
            font-size: 18px; 
            color: #4b3f72; 
        } 
        .chatbot-title { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        } 
        .chatbot-header-logo { 
            width: 24px; 
            height: 24px; 
            object-fit: contain; 
        } 
        .chatbot-close { 
            background: none; 
            border: none; 
            font-size: 18px; 
            color: #4b3f72; 
            cursor: pointer; 
        } 
        .chatbot-body { 
            flex-grow: 1; 
            padding: 16px; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
        } 
        .bot-message { 
            background: #fff; 
            color: #566785; 
            padding: 10px 14px; 
            border-radius: 12px 12px 12px 4px; 
            max-width: 80%; 
            font-size: 14px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.08); 
        } 
        .user-message { 
            background: #d97452; 
            color: #fff; 
            padding: 10px 14px; 
            border-radius: 12px 12px 4px 12px; 
            align-self: flex-end; 
            max-width: 80%; 
            font-size: 14px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.08); 
        } 
        .chatbot-input-row { 
            display: flex; 
            align-items: center; 
            padding: 12px 16px; 
            background: #d5c9f0; 
            gap: 10px; 
        } 
        .chatbot-input-row input { 
            flex-grow: 1; 
            padding: 10px 14px; 
            border-radius: 12px; 
            border: none; 
            outline: none; 
            font-size: 14px; 
            font-style: italic; 
            color: #566785; 
        } 
        .chatbot-send { 
            background: #d97452; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 32px; 
            height: 32px; 
            font-size: 16px; 
            cursor: pointer; 
        } 
        .summary-icon, .voice-icon { 
            width: 24px; 
            height: 24px; 
            cursor: pointer; 
            transition: transform 0.2s ease; 
        } 
        .summary-icon:hover, .voice-icon:hover { 
            transform: scale(1.1); 
        } 
    </style> 
</head> 
<body> 
    <div class="modal-overlay" id="uploadModal"> 
        <div class="modal-content"> 
            <button class="close-modal" id="closeModal">&times;</button> 
            <h3>Upload Documents</h3> 
            <div class="modal-upload-btn-container" id="modalUploadBtn"> 
                <img src="assets/upload.png" alt="Upload Icon"> 
                <p>Upload Documents</p> 
            </div> 
            <input type="file" id="documentFileInput" multiple hidden /> 
        </div> 
    </div> 

    <div class="message-box" id="messageBox"></div> 

    <div class="wrapper"> 
        <div class="dashboard"> 
            <aside class="sidebar"> 
                <div class="logo-row"> 
                    <div class="logo-container"> 
                        <img src="assets/LOGO.png" alt="Care Yatra Logo"> 
                        <div class="usertype">Usertype: <strong id="userType">Worker</strong></div> 
                    </div> 
                </div> 
                <div class="profilepic">ðŸ‘¤</div> 
                <div class="welcome">Welcome, <span id="welcomeName">[Username]</span></div> 
                <div class="sidebar-btns"> 
                    <button class="sidebar-btn" data-tab="insights">ðŸ“Š<span>Insights</span></button> 
                    <button class="sidebar-btn" data-tab="profile">ðŸ‘¤<span>Profile</span></button> 
                    <button class="sidebar-btn" data-tab="family">ðŸ‘ª<span>Family</span></button> 
                    <button class="sidebar-btn" data-tab="appointment">ðŸ“…<span>Appointment</span></button> 
                    <button class="sidebar-btn" data-tab="notifications">ðŸ””<span>Notifications</span></button> 
                    <button class="sidebar-btn" data-tab="documents">ðŸ“‚<span>Documents</span></button> 
                </div> 
                <div class="qrcode-container"> 
                    <img id="qrCodeImage" src="assets/qr-code.png" alt="QR Code"> 
                    <!--<img id="qrCodeImage" src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=UserProfile" alt="QR Code"> --> 
                </div> 
                <button class="logout-btn">ðŸšª Log Out</button> 
            </aside> 

            <main class="inner-window"> 
                <section class="tab tab-insights"> 
                    <div class="tab-title">Insights</div> 
                    <div class="content-card"> 
                        <p>This section is handled by an external application.</p> 
                    </div> 
                </section> 

                <section class="tab tab-profile active"> 
                    <div class="tab-title">My Profile</div> 

                    <div class="finalized-profile-view" id="finalizedProfileView" style="display: none;"> 
                        <p><strong>Name:</strong> <span id="finalName"></span></p> 
                        <p><strong>ABHA ID:</strong> <span id="finalAbhaId"></span></p> 
                        <p><strong>Date of Birth:</strong> <span id="finalDob"></span></p> 
                        <p><strong>Blood Group:</strong> <span id="finalBloodGroup"></span></p> 
                        <p><strong>Age:</strong> <span id="finalAge"></span></p> 
                        <p><strong>Work / Occupation:</strong> <span id="finalOccupation"></span></p> 
                        <p><strong>Allergies:</strong> <span id="finalAllergies"></span></p> 
                        <p><strong>Spoken Languages:</strong> <span id="finalLanguages"></span></p> 
                        <p><strong>Permanent Address:</strong> <span id="finalPermanentAddress"></span></p> 
                        <p><strong>Current Address:</strong> <span id="finalCurrentAddress"></span></p> 
                        <p><strong>Employer Name:</strong> <span id="finalEmployerName"></span></p> 
                        <p><strong>Employer Phone:</strong> <span id="finalEmployerPhone"></span></p> 

                        <div class="vaccination-section"> 
                            <h3>Vaccinations Done</h3> 
                            <ul id="finalVaccinationList" class="finalized-vaccination-list"> 
                            </ul> 
                        </div> 
                        <div style="text-align: center; margin-top: 25px;"> 
                            <button id="editProfileBtn" style="background: #e66892; color: #fff; font-weight: bold; padding: 12px 30px; border-radius: 12px; border: none; cursor: pointer;">Edit Profile</button> 
                        </div> 
                    </div> 

                    <div id="profileFormContainer"> 
                        <div class="content-card"> 
                            <form id="profileForm"> 
                                <div class="profile-form-grid"> 
                                    <div> 
                                        <label for="profileName">Name:</label> 
                                        <input type="text" id="profileName" name="name" placeholder="Enter your full name" /> 
                                    </div> 
                                    <div> 
                                        <label for="profileAbhaId">ABHA ID:</label> 
                                        <input type="text" id="profileAbhaId" name="abhaId" placeholder="Enter your ABHA ID" /> 
                                    </div> 
                                    <div> 
                                        <label for="profileDob">Date of Birth:</label> 
                                        <input type="date" id="profileDob" name="dob" /> 
                                    </div> 
                                    <div> 
                                        <label for="profileBloodGroup">Blood Group:</label> 
                                        <select id="profileBloodGroup" name="bloodGroup"> 
                                            <option value="">Select</option> 
                                            <option value="A+">A+</option> 
                                            <option value="A-">A-</option> 
                                            <option value="B+">B+</option> 
                                            <option value="B-">B-</option> 
                                            <option value="AB+">AB+</option> 
                                            <option value="AB-">AB-</option> 
                                            <option value="O+">O+</option> 
                                            <option value="O-">O-</option> 
                                        </select> 
                                    </div> 
                                    <div> 
                                        <label for="profileAge">Age:</label> 
                                        <input type="number" id="profileAge" name="age" placeholder="Age" /> 
                                    </div> 
                                    <div> 
                                        <label for="profileOccupation">Work / Occupation:</label> 
                                        <input type="text" id="profileOccupation" name="occupation" placeholder="Your occupation" /> 
                                    </div> 
                                    <div style="grid-column: 1/3;"> 
                                        <label for="profileAllergies">Any Allergies or Health Conditions:</label> 
                                        <input type="text" id="profileAllergies" name="allergies" placeholder="e.g., Asthma, Penicillin allergy" /> 
                                    </div> 
                                    <div> 
                                        <label for="languageInput">Spoken Languages:</label> 
                                        <div class="language-input-container"> 
                                            <div class="language-tag-display" id="languageTagDisplay"> 
                                                <input type="text" id="languageInput" placeholder="Add languages..."> 
                                            </div> 
                                            <ul class="language-suggestions" id="languageSuggestions" style="display: none;"></ul> 
                                        </div> 
                                    </div> 
                                    <div style="grid-column: 1/3;"> 
                                        <label for="profilePermanentAddress">Permanent Address (Home State):</label> 
                                        <input type="text" id="profilePermanentAddress" name="permanentAddress" placeholder="Your permanent address" /> 
                                    </div> 
                                    <div style="grid-column: 1/3;"> 
                                        <label for="profileCurrentAddress">Current Residence Address (Kerala):</label> 
                                        <input type="text" id="profileCurrentAddress" name="currentAddress" placeholder="Your current address in Kerala" /> 
                                    </div> 
                                    <div> 
                                        <label for="profileEmployerName">Employer Name:</label> 
                                        <input type="text" id="profileEmployerName" name="employerName" placeholder="Your employer's name" /> 
                                    </div> 
                                    <div> 
                                        <label for="profileEmployerPhone">Employer Phone Number:</label> 
                                        <input type="tel" id="profileEmployerPhone" name="employerPhone" placeholder="10-digit phone number" /> 
                                    </div> 
                                </div> 
                                <div class="vaccination-section"> 
                                    <h3>Vaccinations Done</h3> 
                                    <ul id="vaccinationList" style="list-style: none; padding: 0;"> 
                                    </ul> 
                                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;"> 
                                        <select id="vaccineType" style="flex: 2; padding: 8px; border-radius: 8px; border: 1px solid #cce5ff;"> 
                                            <option value="">Select Vaccine</option> 
                                            <option value="COVID-19 - Covaxin">COVID-19 - Covaxin</option> 
                                            <option value="COVID-19 - Covishield">COVID-19 - Covishield</option> 
                                            <option value="Tetanus">Tetanus</option> 
                                            <option value="Hepatitis B">Hepatitis B</option> 
                                            <option value="Influenza">Influenza</option> 
                                            <option value="MMR">MMR (Measles, Mumps, Rubella)</option> 
                                        </select> 
                                        <input type="date" id="vaccineDate" style="flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #cce5ff;"> 
                                        <button type="button" id="addVaccineBtn" style="padding: 8px 15px; border-radius: 8px; background: #6185d6; color: #fff; border: none; cursor: pointer;">Add</button> 
                                    </div> 
                                </div> 
                                <div style="text-align: center; margin-top: 25px;"> 
                                    <button type="submit" id="saveProfileBtn" style="background: #5285ec; color: #fff; font-weight: bold; padding: 12px 30px; border-radius: 12px; border: none; cursor: pointer; transition: background 0.25s;">Save Profile</button> 
                                </div> 
                            </form> 
                        </div> 
                    </div> 
                </section> 

                <section class="tab tab-family"> 
                    <div class="family-emergency-grid"> 
                        <div class="family-box"> 
                            <div class="family-title">My Family Members</div> 
                            <ul class="family-list" id="familyList"> 
                            </ul> 
                            <div class="add-member-row"> 
                                <span class="add-member-icon">âž•</span>(Add More Members) 
                            </div> 
                            <form class="add-member-form"> 
                                <label>Fill in the Information to Add Member:</label> 
                                <input id="newMemberName" type="text" placeholder="Name"/> 
                                <input id="newMemberAbhaId" type="text" placeholder="Abha Id"/> 
                                <label>Add as:</label> 
                                <select id="addMemberType"> 
                                    <option value="family">Family Member</option> 
                                    <option value="emergency">Emergency Contact</option> 
                                    <option value="both">Both</option> 
                                </select> 
                                <button id="addMemberButton" type="submit">Add +</button> 
                            </form> 
                        </div> 
                        <div class="emergency-box"> 
                            <div class="emergency-title">My Emergency Info</div> 
                            <ul class="emergency-list" id="emergencyList"> 
                            </ul> 
                        </div> 
                    </div> 
                </section> 

                <section class="tab tab-appointment"> 
                    <div class="tab-title">Schedule an Appointment</div> 
                    <div class="content-card"> 
                        <form id="appointmentForm" class="appointment-form" style="display: grid; grid-template-columns:1fr 1fr; gap:18px;"> 
                            <div style="grid-column:1/3;"> 
                                <label>Doctor ID: <input type="text" name="doctorID" style="width:90%; margin-bottom:8px;"/></label> 
                            </div> 
                            <div> 
                                <label>Time: <input type="time" name="time" style="width:80%; margin-bottom:8px;"/></label> 
                            </div> 
                            <div> 
                                <label>Date: <input type="date" name="date" style="width:80%; margin-bottom:8px;"/></label> 
                            </div> 
                            <div style="grid-column:1/3;"> 
                                <label>Reason: <input type="text" name="reason" style="width:90%; margin-bottom:8px;"/></label> 
                            </div> 
                            <div style="grid-column:1/3;"> 
                                <label>Priority: <input type="text" name="priority" style="width:90%; margin-bottom:8px;"/></label> 
                            </div> 
                            <div style="grid-column:1/3; text-align:center;"> 
                                <button type="submit">Schedule</button> 
                            </div> 
                        </form> 
                    </div> 
                </section> 

                <section class="tab tab-notifications"> 
                    <div class="tab-title">Notifications</div> 
                    <div class="content-card"> 
                        <p>Check your latest alerts and reminders here.</p> 
                    </div> 
                </section> 

                <section class="tab tab-documents"> 
                    <div class="tab-title">Documents Uploaded</div> 
                    <div class="content-card"> 
                        <ul id="uploadedFilesDisplay" style="list-style:none; padding:0; margin:0;"> 
                        </ul> 
                    </div> 
                    <div class="content-card" style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:24px;"> 
                        <div style="background:#b5e3f7; padding:20px; border-radius:12px;"> 
                            <h3>Dentist Folder</h3> 
                            <p>[Files go here]</p> 
                        </div> 
                        <div style="background:#9fd3f5; padding:20px; border-radius:12px;"> 
                            <h3>Derma Folder</h3> 
                            <p>[Files go here]</p> 
                        </div> 
                        <div style="background:#c5e7ff; padding:20px; border-radius:12px;"> 
                            <h3>Reports</h3> 
                            <p>[Files go here]</p> 
                        </div> 
                        <div style="background:#a0c9f3; padding:20px; border-radius:12px;"> 
                            <h3>Other Documents</h3> 
                            <p>[Files go here]</p> 
                        </div> 
                    </div> 
                </section> 

                <!-- ABHA AI Chatbot HTML, now inside the main window --> 
                <div id="abhaChatWindow" class="chatbot-overlay"> 
                    <div class="chatbot-window"> 
                        <div class="chatbot-header"> 
                            <div class="chatbot-title"> 
                                <img src="assets/WorkerABHA_AI.png" alt="ABHA Logo" class="chatbot-header-logo" /> 
                                <span>ABHA AI</span> 
                            </div> 
                            <button class="chatbot-close" onclick="closeAbhaChat()">âœ–</button> 
                        </div> 
                        <div class="chatbot-body" id="chatBody"> 
                            <div class="bot-message" id="chatGreeting">Hi ðŸ‘‹<br>How can I assist you today?</div> 
                        </div> 
                        <div class="chatbot-input-row"> 
                            <input type="text" id="chatInput" placeholder="Summarize report or ask a medical query..." /> 
                            <input type="file" id="fileInput" hidden /> 
                            <img src="assets/summarizer.png" alt="Summarizer Icon" class="summary-icon" id="summaryIcon" /> 
                            <img src="assets/voice.png" alt="Voice Input Icon" class="voice-icon" id="voiceIcon" /> 
                            <button class="chatbot-send" onclick="sendMessage()">âž¤</button> 
                        </div> 
                    </div> 
                </div> 
                <div class="abha-logo-container" id="abhaLogoContainer"> 
                    <img src="assets/WorkerABHA_AI.png" alt="ABHA AI Logo" class="abha-logo" /> 
                </div> 
            </main> 
        </div> 
    </div> 

    <script> 
        const buttons = document.querySelectorAll('.sidebar-btn'); 
        const tabs = document.querySelectorAll('.tab'); 
        
        const welcomeNameElement = document.getElementById('welcomeName'); 
        const userTypeElement = document.getElementById('userType'); 
        const familyListEl = document.getElementById('familyList'); 
        const newMemberNameInput = document.getElementById('newMemberName'); 
        const newMemberAbhaIdInput = document.getElementById('newMemberAbhaId'); 
        const addMemberTypeSelect = document.getElementById('addMemberType'); 
        const addMemberButton = document.getElementById('addMemberButton'); 
        const appointmentForm = document.getElementById('appointmentForm'); 

        const profileFormContainer = document.getElementById('profileFormContainer'); 
        const profileForm = document.getElementById('profileForm'); 
        const finalizedProfileView = document.getElementById('finalizedProfileView'); 
        const editProfileBtn = document.getElementById('editProfileBtn'); 
        const saveProfileBtn = document.getElementById('saveProfileBtn'); 
        const addVaccineBtn = document.getElementById('addVaccineBtn'); 
        const vaccinationList = document.getElementById('vaccinationList'); 
        const finalVaccinationList = document.getElementById('finalVaccinationList'); 
        
        let vaccinationData = []; 
        
        const emergencyListEl = document.getElementById('emergencyList'); 
        
        const languageInput = document.getElementById('languageInput'); 
        const languageTagDisplay = document.getElementById('languageTagDisplay'); 
        const languageSuggestions = document.getElementById('languageSuggestions'); 
        let selectedLanguages = []; 
        const allLanguages = ["Hindi", "Bengali", "Assamese", "Odia", "Malayalam", "Tamil", "Kannada", "Telugu"]; 

        const uploadModal = document.getElementById('uploadModal'); 
        const closeModalBtn = document.getElementById('closeModal'); 
        const modalUploadBtn = document.getElementById('modalUploadBtn'); 
        const documentFileInput = document.getElementById('documentFileInput'); 
        const uploadedFilesDisplay = document.getElementById('uploadedFilesDisplay'); 
        const messageBox = document.getElementById('messageBox'); 
        const qrCodeImage = document.getElementById('qrCodeImage'); 

        // New elements for ABHA AI 
        const abhaLogoContainer = document.getElementById('abhaLogoContainer'); 
        const abhaChatWindow = document.getElementById('abhaChatWindow'); 
        const chatInput = document.getElementById('chatInput'); 
        const chatBody = document.getElementById('chatBody'); 
        const summaryIcon = document.getElementById('summaryIcon'); 
        const voiceIcon = document.getElementById('voiceIcon'); 
        const fileInput = document.getElementById('fileInput'); 

        function showMessage(message, isSuccess = true) { 
            messageBox.textContent = message; 
            messageBox.style.backgroundColor = isSuccess ? '#4CAF50' : '#f44336'; 
            messageBox.style.display = 'block'; 
            setTimeout(() => { 
                messageBox.style.display = 'none'; 
            }, 3000); 
        } 

        // --- NEW HELPER FUNCTION TO FETCH AND DISPLAY QR CODE --- 
        async function fetchAndDisplayQrCode(username) { 
            const qrCodeImage = document.getElementById('qrCodeImage'); 

            try { 
                // Calls the Flask backend route to trigger generation 
                const qrResponse = await fetch(`/api/generate-qr/${username}`); 
                const qrData = await qrResponse.json(); 

                if (qrResponse.ok && qrData.status === 'success') { 
                    // Update the image source with the URL returned by Flask 
                    qrCodeImage.src = qrData.qr_url; 
                    qrCodeImage.alt = `QR Code for ${username}`; 
                } else { 
                    // Handle the error if Flask says the profile data is missing 
                    console.error('Failed to generate or retrieve QR code:', qrData.message); 
                    qrCodeImage.src = 'assets/qr-code.png'; // Fallback to default placeholder 
                    qrCodeImage.alt = 'QR Code unavailable. Save profile first.'; 
                } 
            } catch (error) { 
                // Handle network errors (e.g., Flask server is down) 
                console.error('Network error during QR code fetch:', error); 
                qrCodeImage.src = 'assets/qr-code.png'; // Fallback 
                qrCodeImage.alt = 'QR Code unavailable due to network error.'; 
            } 
        } 

        languageInput.addEventListener('input', () => { 
            const query = languageInput.value.toLowerCase(); 
            languageSuggestions.innerHTML = ''; 

            if (query.length > 0) { 
                const filteredLanguages = allLanguages.filter(lang => 
                    lang.toLowerCase().startsWith(query) && !selectedLanguages.includes(lang) 
                ); 

                filteredLanguages.forEach(lang => { 
                    const li = document.createElement('li'); 
                    li.textContent = lang; 
                    li.addEventListener('click', () => { 
                        addLanguageTag(lang); 
                        languageInput.value = ''; 
                        languageSuggestions.style.display = 'none'; 
                    }); 
                    languageSuggestions.appendChild(li); 
                }); 
                languageSuggestions.style.display = filteredLanguages.length > 0 ? 'block' : 'none'; 
            } else { 
                languageSuggestions.style.display = 'none'; 
            } 
        }); 

        function addLanguageTag(lang) { 
            if (!selectedLanguages.includes(lang)) { 
                selectedLanguages.push(lang); 
                const tag = document.createElement('span'); 
                tag.className = 'language-tag'; 
                tag.innerHTML = ` 
                    <span>${lang}</span> 
                    <span class="remove-tag">Ã—</span> 
                `; 
                tag.querySelector('.remove-tag').addEventListener('click', () => { 
                    selectedLanguages = selectedLanguages.filter(l => l !== lang); 
                    tag.remove(); 
                }); 
                languageTagDisplay.insertBefore(tag, languageInput); 
            } 
        } 

        document.addEventListener('click', (e) => { 
            if (!e.target.closest('.language-input-container')) { 
                languageSuggestions.style.display = 'none'; 
            } 
        }); 

        const insightsButton = document.querySelector('[data-tab="insights"]'); 

        insightsButton.addEventListener('click', (e) => { 
            e.preventDefault(); 
            window.open('http://192.168.243.148:8502', '_blank'); 
        }); 

        buttons.forEach(btn => { 
            btn.addEventListener('click', () => { 
                buttons.forEach(b => b.classList.remove('active')); 
                btn.classList.add('active'); 
                tabs.forEach(tab => tab.classList.remove('active')); 

                const targetTab = document.querySelector('.tab-' + btn.dataset.tab); 
                if (targetTab) { 
                    targetTab.classList.add('active'); 
                } else if (btn.dataset.tab === 'qrcode') { 
                    // QR code button no longer a tab, but its listener could be here if needed 
                } 
            }); 
        }); 

        document.querySelector('.logout-btn').addEventListener('click', () => { 
            showMessage('Logged out successfully!'); 
            setTimeout(() => { window.location.href = '/'; }, 500); 
        }); 

        document.body.addEventListener('click', function(e) { 
            document.querySelectorAll('.options-menu').forEach(menu => menu.style.display = 'none'); 
        }); 

        function showOptionsMenu(btn, type) { 
            event.stopPropagation(); 
            var menu = btn.parentElement.querySelector('.options-menu'); 
            document.querySelectorAll('.options-menu').forEach(m => m.style.display = 'none'); 
            menu.style.display = 'block'; 
        } 

        function optionAction(type) { 
            showMessage('Chosen: ' + type); 
            document.querySelectorAll('.options-menu').forEach(menu => menu.style.display = 'none'); 
        } 

        function renderFamilyMembers(members) { 
            familyListEl.innerHTML = members.length > 0 ? '' : '<li>No family members found.</li>'; 
            members.forEach((member, index) => { 
                const li = document.createElement('li'); 
                li.innerHTML = ` 
                    <span>${index + 1}. ${member.Name} <span style="color:#868d96;">(${member.Profile_Type})</span></span> 
                    <span class="family-actions" style="position:relative;"> 
                        <button class="link-btn">ðŸ”—</button> 
                        <button class="remove-btn">ðŸ—‘</button> 
                    </span> 
                `; 
                familyListEl.appendChild(li); 
            }); 
        } 

        async function fetchAndRenderFamily() { 
            const urlParams = new URLSearchParams(window.location.search); 
            const username = urlParams.get('user'); 
            if (!username) return; 

            try { 
                const response = await fetch(`/api/patient-family/${username}`); 
                if (response.ok) { 
                    const familyMembers = await response.json(); 
                    renderFamilyMembers(familyMembers); 
                } else { 
                    console.error('Failed to fetch family data'); 
                    familyListEl.innerHTML = '<li>Error fetching family members.</li>'; 
                } 
            } catch (error) { 
                console.error('An error occurred while fetching family data:', error); 
                familyListEl.innerHTML = '<li>Error fetching family members.</li>'; 
            } 
        } 

        document.querySelector('.add-member-form').addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const newMemberName = newMemberNameInput.value.trim(); 
            const newMemberAbhaId = newMemberAbhaIdInput.value.trim(); 
            const addMemberType = addMemberTypeSelect.value; 

            if (!newMemberName || !newMemberAbhaId) { 
                showMessage('Please enter both name and ABHA ID.'); 
                return; 
            } 

            console.log(`Adding new member: ${newMemberName}, ABHA: ${newMemberAbhaId}, Type: ${addMemberType}`); 

            if (addMemberType === 'family' || addMemberType === 'both') { 
                const memberLi = document.createElement('li'); 
                memberLi.innerHTML = ` 
                    <span>${familyListEl.children.length + 1}. ${newMemberName} <span style="color:#868d96;">(Family Member)</span></span> 
                    <span class="family-actions" style="position:relative;"> 
                        <button class="link-btn">ðŸ”—</button> 
                        <button class="remove-btn">ðŸ—‘</button> 
                    </span> 
                `; 
                familyListEl.appendChild(memberLi); 
            } 

            if (addMemberType === 'emergency' || addMemberType === 'both') { 
                const emergencyLi = document.createElement('li'); 
                emergencyLi.innerHTML = `<strong>${newMemberName}</strong> - ABHA ID: ${newMemberAbhaId}`; 
                emergencyListEl.appendChild(emergencyLi); 
            } 

            newMemberNameInput.value = ''; 
            newMemberAbhaIdInput.value = ''; 
        }); 


        appointmentForm.addEventListener('submit', async (e) => { 
            e.preventDefault(); 

            const formData = new FormData(appointmentForm); 
            const data = Object.fromEntries(formData.entries()); 

            const appointmentData = { 
                doctorID: data.doctorID, 
                time: data.time, 
                date: data.date, 
                reason: data.reason, 
                priority: data.priority, 
            }; 

            console.log('Attempting to schedule appointment with data:', appointmentData); 

            try { 
                const response = await fetch('/api/schedule-appointment', { 
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json', 
                    }, 
                    body: JSON.stringify(appointmentData), 
                }); 

                if (response.ok) { 
                    showMessage('Appointment scheduled successfully!'); 
                    appointmentForm.reset(); 
                } else { 
                    const errorText = await response.text(); 
                    showMessage(`Failed to schedule appointment: ${errorText}`, false); 
                } 
            } catch (error) { 
                showMessage('An error occurred. Please try again.', false); 
                console.error('Appointment scheduling failed:', error); 
            } 
        }); 


        profileForm.addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const formData = new FormData(profileForm); 
            const profileData = Object.fromEntries(formData.entries()); 

            // Step 1: Prepare complex fields 
            profileData.languages = selectedLanguages.join(', '); 
            profileData.vaccinations = vaccinationData; 

            // Validation Check (Your original logic) 
            const isAnyFieldFilled = Object.values(profileData).some(value => value && value.length > 0); 
            if (!isAnyFieldFilled && vaccinationData.length === 0) { 
                showMessage("No details entered. Please fill in at least one field to save your profile.", false); 
                return; 
            } 

            console.log('Profile data to be sent for saving:', profileData); 

            // ========================================================= 
            // *** NEW LOGIC: SEND DATA TO FLASK BACKEND FOR SAVING *** // ========================================================= 
            try { 
                const response = await fetch('/api/save-profile', { 
                    method: 'POST', 
                    headers: { 
                        'Content-Type': 'application/json', // Flask expects JSON 
                    }, 
                    body: JSON.stringify(profileData), 
                }); 

                const result = await response.json(); 

                // --- CHECK API SUCCESS --- 
                if (response.ok && result.status === 'success') { 
                    showMessage("Profile saved successfully to the server!", true); 

                    // CRITICAL: Call the new function to refresh the QR code 
                    //await fetchAndDisplayQrCode(profileData.abhaId); 
                    const qrCodeImage = document.getElementById('qrCodeImage'); 

                    // ASSUMPTION: You have an image named 'Amit Shengal_qr.png' in your frontend/assets folder. 
                    qrCodeImage.src = 'assets/Amit Shengal_qr.png'; 
                    qrCodeImage.alt = 'QR Code Updated (Demo)'; 

                } else { 
                    // Handle server-side errors 
                    showMessage(`Error saving profile: ${result.message || 'Server error.'}`, false); 
                    console.error('Server error saving profile:', result); 
                    return; 
                } 
            } catch (error) { 
                // Handle network issues 
                showMessage("A network error occurred while trying to save the profile.", false); 
                console.error('Network error on profile save:', error); 
                return; 
            } 
            // ========================================================= 
            // *** END NEW LOGIC *** // ========================================================= 

            // Step 3: Update local UI only if the server save was successful 
            updateEmergencyInfo(profileData.employerName, profileData.employerPhone); 
            displayFinalizedProfile(profileData); 
        }); 

        function updateEmergencyInfo(name, phone) { 
            const existingEmployer = emergencyListEl.querySelector('#employer-info'); 
            if (existingEmployer) { 
                existingEmployer.remove(); 
            } 

            if (name && phone) { 
                const li = document.createElement('li'); 
                li.id = 'employer-info'; 
                li.innerHTML = `<strong>Employer:</strong> ${name}, ${phone}`; 
                emergencyListEl.appendChild(li); 
            } 
        } 

        function displayFinalizedProfile(data) { 
            document.getElementById('finalName').textContent = data.name; 
            document.getElementById('finalAbhaId').textContent = data.abhaId; 
            document.getElementById('finalDob').textContent = data.dob; 
            document.getElementById('finalBloodGroup').textContent = data.bloodGroup; 
            document.getElementById('finalAge').textContent = data.age; 
            document.getElementById('finalOccupation').textContent = data.occupation; 
            document.getElementById('finalAllergies').textContent = data.allergies; 
            document.getElementById('finalLanguages').textContent = data.languages; 
            document.getElementById('finalPermanentAddress').textContent = data.permanentAddress; 
            document.getElementById('finalCurrentAddress').textContent = data.currentAddress; 
            document.getElementById('finalEmployerName').textContent = data.employerName; 
            document.getElementById('finalEmployerPhone').textContent = data.employerPhone; 

            finalVaccinationList.innerHTML = ''; 
            data.vaccinations.forEach((vaccine, index) => { 
                const li = document.createElement('li'); 
                li.innerHTML = ` 
                    <span><strong>${vaccine.type}</strong> on ${new Date(vaccine.date).toLocaleDateString()}</span> 
                    <button class="edit-btn" data-index="${index}">Edit</button> 
                `; 
                finalVaccinationList.appendChild(li); 
            }); 

            profileFormContainer.style.display = 'none'; 
            finalizedProfileView.style.display = 'block'; 
        } 

        editProfileBtn.addEventListener('click', () => { 
            finalizedProfileView.style.display = 'none'; 
            profileFormContainer.style.display = 'block'; 
        }); 

        addVaccineBtn.addEventListener('click', () => { 
            const vaccineType = document.getElementById('vaccineType').value; 
            const vaccineDate = document.getElementById('vaccineDate').value; 

            if (vaccineType && vaccineDate) { 
                vaccinationData.push({ type: vaccineType, date: vaccineDate }); 

                const li = document.createElement('li'); 
                li.style.cssText = 'padding: 8px 12px; margin-bottom: 8px; background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); font-size: 0.9em;'; 
                li.innerHTML = `<strong>${vaccineType}</strong> on ${new Date(vaccineDate).toLocaleDateString()}`; 
                vaccinationList.appendChild(li); 

                document.getElementById('vaccineType').value = ''; 
                document.getElementById('vaccineDate').value = ''; 
            } else { 
                showMessage('Please select a vaccine type and date.', false); 
            } 
        }); 

        finalVaccinationList.addEventListener('click', (e) => { 
            if (e.target.classList.contains('edit-btn')) { 
                const index = e.target.dataset.index; 
                const vaccine = vaccinationData[index]; 

                showMessage(`You can now edit the entry for ${vaccine.type} on ${new Date(vaccine.date).toLocaleDateString()}.`); 
            } 
        }); 

        const documentsTabBtn = document.querySelector('[data-tab="documents"]'); 
        documentsTabBtn.addEventListener('click', (e) => { 
            e.preventDefault(); 
            buttons.forEach(b => b.classList.remove('active')); 
            documentsTabBtn.classList.add('active'); 
            tabs.forEach(tab => tab.classList.remove('active')); 
            document.querySelector('.tab-documents').classList.add('active'); 

            uploadModal.style.display = 'flex'; 
        }); 

        closeModalBtn.addEventListener('click', () => { 
            uploadModal.style.display = 'none'; 
        }); 

        modalUploadBtn.addEventListener('click', () => { 
            documentFileInput.click(); 
        }); 

        documentFileInput.addEventListener('change', (event) => { 
            const files = event.target.files; 
            if (files.length > 0) { 
                showMessage(`Uploading ${files.length} file(s)...`); 

                setTimeout(() => { 
                    showMessage('Documents uploaded successfully!'); 

                    for (const file of files) { 
                        const li = document.createElement('li'); 
                        li.innerHTML = `<span class="file-icon">ðŸ“</span>${file.name}<span style="color: #4CAF50;">(Uploaded)</span>`; 
                        uploadedFilesDisplay.appendChild(li); 
                    } 

                    documentFileInput.value = ''; 
                    uploadModal.style.display = 'none'; 
                }, 1500); 

                console.log(files); 
            } 
        }); 

        qrCodeImage.addEventListener('click', () => { 
            showMessage('Simulating QR code scan...'); 
            console.log('QR code clicked. Scan event sent to backend.'); 
        }); 

        document.addEventListener('DOMContentLoaded', async () => { 
            const urlParams = new URLSearchParams(window.location.search); 
            const username = urlParams.get('user'); 

            const profileButton = document.querySelector('[data-tab="profile"]'); 
            const profileTab = document.querySelector('.tab-profile'); 
            if (profileButton && profileTab) { 
                buttons.forEach(b => b.classList.remove('active')); 
                profileButton.classList.add('active'); 
                tabs.forEach(tab => tab.classList.remove('active')); 
                profileTab.classList.add('active'); 
            } 

            if (username) { 
                try { 
                    const response = await fetch(`/api/patient-data/${username}`); 
                    if (response.ok) { 
                        const userData = await response.json(); 

                        document.getElementById('finalAbhaId').textContent = username; 

                        welcomeNameElement.textContent = userData.name || userData.username; 
                        userTypeElement.textContent = userData.user_type; 
                    } else { 
                        console.error('Failed to fetch user data'); 
                        welcomeNameElement.textContent = 'User not found'; 
                    } 
                } catch (error) { 
                    console.error('An error occurred while fetching user data:', error); 
                    welcomeNameElement.textContent = 'Error fetching data'; 
                } 
            } 

            // --- START NEW QR CODE DISPLAY LOGIC --- 
            // In patientdash.html (Inside document.addEventListener('DOMContentLoaded', ...)) 

            // ... (your existing code to get URL params and set active tabs) ... 

            if (username) { 
                // --- Existing logic to fetch patient data is fine --- 
                try { 
                    const response = await fetch(`/api/patient-data/${username}`); 
                    if (response.ok) { 
                        const userData = await response.json(); 
                        welcomeNameElement.textContent = userData.name || userData.username; 
                        userTypeElement.textContent = userData.user_type; 
                    } else { 
                        console.error('Failed to fetch user data'); 
                        welcomeNameElement.textContent = 'User not found'; 
                    } 
                } catch (error) { 
                    console.error('An error occurred while fetching user data:', error); 
                    welcomeNameElement.textContent = 'Error fetching data'; 
                } 


                // Call the helper function to load the QR code based on the username 
                await fetchAndDisplayQrCode(username); 
            } 
            // ... (fetchAndRenderFamily() follows immediately after) 
            // --- END NEW QR CODE DISPLAY LOGIC --- 

            fetchAndRenderFamily(); 
        }); 

        // ABHA AI Chatbot Functions 
        function closeAbhaChat() { 
            abhaChatWindow.style.display = 'none'; 
        } 

        async function sendMessage() { 
            const message = chatInput.value.trim(); 
            if (!message) return; 

            const userMsg = document.createElement('div'); 
            userMsg.className = 'user-message'; 
            userMsg.textContent = message; 
            chatBody.appendChild(userMsg); 

            chatInput.value = ''; 
            chatBody.scrollTop = chatBody.scrollHeight; 

            const botMsg = document.createElement('div'); 
            botMsg.className = 'bot-message'; 
            botMsg.textContent = 'ABHA AI is thinking...'; 
            chatBody.appendChild(botMsg); 
            chatBody.scrollTop = chatBody.scrollHeight; 

            try { 
                const response = await fetch('/api/abha-chat', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ query: message }) 
                }); 
                const data = await response.json(); 
                botMsg.textContent = data.reply; 
            } catch (error) { 
                console.error('ABHA AI chat failed:', error); 
                botMsg.textContent = "An error occurred. Please try again."; 
            } 

            chatBody.scrollTop = chatBody.scrollHeight; 
        } 

        // Event listeners for the new features 
        abhaLogoContainer.addEventListener('click', () => { 
            abhaChatWindow.style.display = 'flex'; 
            const username = welcomeNameElement.textContent.replace('Welcome, ', '').trim(); 
            document.getElementById('chatGreeting').innerHTML = `Hi ${username} ðŸ‘‹<br>How can I assist you today?`; 
        }); 

        summaryIcon.addEventListener('click', () => { 
            fileInput.click(); 
            fileInput.onchange = function() { 
                if (fileInput.files.length > 0) { 
                    showMessage('File selected for summarization!'); 
                    console.log('File to be summarized:', fileInput.files[0].name); 
                } 
            }; 
        }); 

        voiceIcon.addEventListener('click', () => { 
            showMessage('Voice input initiated. Please speak now...'); 
            console.log('Voice input icon clicked.'); 
        }); 

        const notificationsList = document.querySelector('.tab-notifications .content-card'); 

        async function fetchPrescriptions() { 
            // 1. Get the patient's ABHA ID from the URL (which was passed during redirection) 
            const urlParams = new URLSearchParams(window.location.search); 
            const abhaId = urlParams.get('user'); 

            // Fallback: If ABHA ID hasn't fully loaded, use the profile element. 
            const finalAbhaIdEl = document.getElementById('finalAbhaId'); 
            const patientId = abhaId || (finalAbhaIdEl ? finalAbhaIdEl.textContent.trim() : null); 

            const notificationsListContainer = document.querySelector('.tab-notifications .content-card'); 

            if (!patientId || patientId === 'D-123456') { 
                notificationsListContainer.innerHTML = '<p>Cannot fetch prescriptions: ABHA ID is missing.</p>'; 
                return; 
            } 

            notificationsListContainer.innerHTML = 'Fetching prescriptions...'; // Show loading 

            try { 
                // 2. Call Flask endpoint to get the list of prescriptions 
                const response = await fetch(`/api/patient-prescriptions/${patientId}`); 

                if (!response.ok) throw new Error('Failed to fetch prescriptions list.'); 

                const prescriptions = await response.json(); 

                notificationsListContainer.innerHTML = ''; // Clear loading message 

                if (prescriptions.length === 0) { 
                    notificationsListContainer.innerHTML = '<p>No new prescriptions received.</p>'; 
                    return; 
                } 

                // Display prescriptions, newest first (optional: .reverse()) 
                prescriptions.forEach((p, index) => { 
                    const div = document.createElement('div'); 
                    // Use the file property to generate the download link 
                    const fileName = p.file; 

                    // Format the message content 
                    div.className = 'notification-item content-card'; 
                    div.style.cssText = 'display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;'; 
                    div.innerHTML = ` 
                        <div> 
                            <p style="margin:0;"> 
                                Prescription #${index + 1} from 
                                <strong>${p.doctor_name}</strong> 
                            </p> 
                            <p style="margin:0; font-size:0.9em; color:#555;"> 
                                Dated: ${p.date} at ${p.time} 
                            </p> 
                        </div> 
                        <button class="download-btn" 
                            style="background:#5285ec; color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer;" 
                            data-file="${fileName}"> 
                            Download 
                        </button> 
                    `; 

                    // 3. Set up the download listener 
                    div.querySelector('.download-btn').addEventListener('click', (e) => { 
                        const fileToDownload = e.currentTarget.getAttribute('data-file'); 

                        // CRITICAL: This calls the Flask download route which serves the file 
                        window.location.href = `/api/download-prescription/${fileToDownload}`; 
                        showMessage(`Initiating download for ${fileToDownload}...`, true); 
                    }); 

                    notificationsListContainer.appendChild(div); 
                }); 

            } catch (error) { 
                console.error('Error fetching prescriptions:', error); 
                notificationsListContainer.innerHTML = '<p>Error fetching prescriptions or network issue.</p>'; 
            } 
        } 

        // In patientdash.html <script> 

        // ... (other code) ... 

        // Get the notifications button element 
        const notificationsButton = document.querySelector('[data-tab="notifications"]'); 

        // Add the click listener 
        notificationsButton.addEventListener('click', () => { 
            // Standard tab switching logic: 
            buttons.forEach(b => b.classList.remove('active')); 
            notificationsButton.classList.add('active'); 
            tabs.forEach(tab => tab.classList.remove('active')); 
            document.querySelector('.tab-notifications').classList.add('active'); 

            // CRITICAL FIX: Call the fetch function when the tab is opened 
            fetchPrescriptions(); // <--- THIS LINE MUST BE PRESENT! 
        }); 

        // If you are using the old method: 
        // document.querySelector('[data-tab="notifications"]').addEventListener('click', fetchPrescriptions); 
        // This is fine too, but make sure the logic inside the listener isn't overriding the fetch. 

        function displayFinalizedProfile(data) { 
            // CRITICAL: Populate the hidden ID span 
            document.getElementById('finalAbhaId').textContent = data.abhaId; 
            // ... (rest of display logic) ... 
        } 

    </script> 
</body> 
</html>



